name: release-tag

on:
  repository_dispatch:
    types: [ latexml-release ]
  workflow_dispatch:
    inputs:
      next_version:
        description: |
          Next release version. Possible values: x.y.z, major, minor, patch or pre|rc|etc
        required: true
        default: 'skip'

permissions:
  contents: write

jobs:
  push-tag:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.METANORMA_CI_PAT_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "metanorma-ci"
          git config --global user.email "metanorma-ci@users.noreply.github.com"

      - name: Install xmllint
        run: |
          sudo apt-get update -y
          sudo apt-get install -y libxml2-utils

      - name: Parse LaTeXML version
        id: version
        env:
          LATEXML_TAG: ${{ github.event.client_payload.ref || github.event.inputs.next_version }}
        run: |
          # Extract version from tag (remove refs/tags/v prefix if present)
          VERSION="${LATEXML_TAG}"
          VERSION="${VERSION#refs/tags/}"
          VERSION="${VERSION#v}"

          echo "Parsed version: ${VERSION}"
          echo "PACKAGE_VERSION=${VERSION}" >> $GITHUB_ENV

      - name: Update latexml.nuspec
        run: |
          CURRENT_YEAR=$(date +%Y)
          xmllint --shell latexml.nuspec << EOF
          setns ns=http://schemas.microsoft.com/packaging/2015/06/nuspec.xsd
          cd /ns:package/ns:metadata/ns:version
          set ${PACKAGE_VERSION}
          cd /ns:package/ns:metadata/ns:copyright
          set ${CURRENT_YEAR} NIST
          save
          exit
          EOF

      - name: Push commit and tag
        run: |
          git add latexml.nuspec
          git commit -m "bump: version ${PACKAGE_VERSION}"
          git tag "v${PACKAGE_VERSION}"
          git push origin HEAD:${GITHUB_REF} --tags
